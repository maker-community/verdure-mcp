@inject IMcpServiceClient McpServiceClient
@inject ISnackbar Snackbar
@inject IStringLocalizer<SharedResources> L

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_formValid">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.Name" Label="@L["ServiceForm_Name"]" Required="true"
                                  RequiredError="@L["ServiceForm_NameRequired"]"
                                  HelperText="@L["ServiceForm_NameHelper"]" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.DisplayName" Label="@L["ServiceForm_DisplayName"]" Required="true"
                                  RequiredError="@L["ServiceForm_DisplayNameRequired"]"
                                  HelperText="@L["ServiceForm_DisplayNameHelper"]" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_model.Description" Label="@L["ServiceForm_Description"]" Lines="3"
                                  HelperText="@L["ServiceForm_DescriptionHelper"]" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="_model.Category" Label="@L["ServiceForm_Category"]" Required="true"
                               RequiredError="@L["ServiceForm_CategoryRequired"]">
                        <MudSelectItem Value="@("image")">@L["ServiceForm_CategoryImage"]</MudSelectItem>
                        <MudSelectItem Value="@("email")">@L["ServiceForm_CategoryEmail"]</MudSelectItem>
                        <MudSelectItem Value="@("document")">@L["ServiceForm_CategoryDocument"]</MudSelectItem>
                        <MudSelectItem Value="@("data")">@L["ServiceForm_CategoryData"]</MudSelectItem>
                        <MudSelectItem Value="@("ai")">@L["ServiceForm_CategoryAI"]</MudSelectItem>
                        <MudSelectItem Value="@("other")">@L["ServiceForm_CategoryOther"]</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.EndpointRoute" Label="@L["ServiceForm_EndpointRoute"]" Required="true"
                                  RequiredError="@L["ServiceForm_EndpointRequired"]"
                                  HelperText="@L["ServiceForm_EndpointHelper"]" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.Version" Label="@L["ServiceForm_Version"]"
                                  HelperText="@L["ServiceForm_VersionHelper"]" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.Author" Label="@L["ServiceForm_Author"]" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.DocumentationUrl" Label="@L["ServiceForm_DocsUrl"]"
                                  HelperText="@L["ServiceForm_DocsHelper"]" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.IconUrl" Label="@L["ServiceForm_IconUrl"]"
                                  HelperText="@L["ServiceForm_IconHelper"]" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_model.Tags" Label="@L["ServiceForm_Tags"]"
                                  HelperText="@L["ServiceForm_TagsHelper"]" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudNumericField @bind-Value="_model.DisplayOrder" Label="@L["ServiceForm_DisplayOrder"]" Min="0"
                                     HelperText="@L["ServiceForm_OrderHelper"]" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudCheckBox @bind-Value="_model.IsEnabled" Label="@L["ServiceForm_EnableService"]" Color="Color.Primary" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudCheckBox @bind-Value="_model.IsFree" Label="@L["ServiceForm_FreeService"]" Color="Color.Success" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">@L["Cancel"]</MudButton>
        <MudButton Color="Color.Primary" OnClick="Save" Disabled="@(!_formValid || _saving)">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
            }
            else
            {
                <text>@L["Save"]</text>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public McpServiceDto? Service { get; set; }

    private MudForm? _form;
    private bool _formValid;
    private bool _saving;
    private McpServiceRequest _model = new();

    protected override void OnInitialized()
    {
        if (Service != null)
        {
            _model = new McpServiceRequest
            {
                Name = Service.Name,
                DisplayName = Service.DisplayName,
                Description = Service.Description,
                Category = Service.Category,
                IconUrl = Service.IconUrl,
                EndpointRoute = Service.EndpointRoute,
                IsEnabled = Service.IsEnabled,
                IsFree = Service.IsFree,
                DisplayOrder = Service.DisplayOrder,
                Version = Service.Version,
                Author = Service.Author,
                DocumentationUrl = Service.DocumentationUrl,
                Tags = Service.Tags
            };
        }
        else
        {
            _model.IsEnabled = true;
            _model.IsFree = true;
        }
    }

    private void Cancel() => MudDialog?.Close(DialogResult.Cancel());

    private async Task Save()
    {
        if (_form != null)
        {
            await _form.Validate();
            if (!_formValid) return;
        }

        _saving = true;
        try
        {
            if (Service != null)
            {
                await McpServiceClient.UpdateServiceAsync(Service.Id, _model);
                Snackbar.Add(L["ServiceForm_UpdateSuccess"], Severity.Success);
            }
            else
            {
                await McpServiceClient.CreateServiceAsync(_model);
                Snackbar.Add(L["ServiceForm_CreateSuccess"], Severity.Success);
            }
            MudDialog?.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["ServiceForm_SaveFailed"], ex.Message), Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }
}
