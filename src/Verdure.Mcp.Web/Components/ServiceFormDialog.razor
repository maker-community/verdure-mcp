@inject IMcpServiceClient McpServiceClient
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_formValid">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.Name" Label="服务名称" Required="true"
                                  RequiredError="请输入服务名称"
                                  HelperText="唯一标识符，如 generate_image" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.DisplayName" Label="显示名称" Required="true"
                                  RequiredError="请输入显示名称"
                                  HelperText="用户看到的名称" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_model.Description" Label="描述" Lines="3"
                                  HelperText="服务的详细描述" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="_model.Category" Label="分类" Required="true"
                               RequiredError="请选择分类">
                        <MudSelectItem Value="@("image")">图片生成</MudSelectItem>
                        <MudSelectItem Value="@("email")">邮件服务</MudSelectItem>
                        <MudSelectItem Value="@("document")">文档处理</MudSelectItem>
                        <MudSelectItem Value="@("data")">数据服务</MudSelectItem>
                        <MudSelectItem Value="@("ai")">AI 服务</MudSelectItem>
                        <MudSelectItem Value="@("other")">其他</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.EndpointRoute" Label="端点路由" Required="true"
                                  RequiredError="请输入端点路由"
                                  HelperText="如 /image/mcp" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.Version" Label="版本"
                                  HelperText="如 1.0.0" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.Author" Label="作者" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.DocumentationUrl" Label="文档链接"
                                  HelperText="外部文档 URL" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.IconUrl" Label="图标链接"
                                  HelperText="图标 URL 或图标名称" />
                </MudItem>
                <MudItem xs="12">
                    <MudTextField @bind-Value="_model.Tags" Label="标签"
                                  HelperText="逗号分隔的标签，如: AI, 图片, 创意" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudNumericField @bind-Value="_model.DisplayOrder" Label="排序" Min="0"
                                     HelperText="数字越小越靠前" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudCheckBox @bind-Value="_model.IsEnabled" Label="启用服务" Color="Color.Primary" />
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudCheckBox @bind-Value="_model.IsFree" Label="免费服务" Color="Color.Success" />
                </MudItem>
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">取消</MudButton>
        <MudButton Color="Color.Primary" OnClick="Save" Disabled="@(!_formValid || _saving)">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
            }
            else
            {
                <text>保存</text>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public McpServiceDto? Service { get; set; }

    private MudForm? _form;
    private bool _formValid;
    private bool _saving;
    private McpServiceRequest _model = new();

    protected override void OnInitialized()
    {
        if (Service != null)
        {
            _model = new McpServiceRequest
            {
                Name = Service.Name,
                DisplayName = Service.DisplayName,
                Description = Service.Description,
                Category = Service.Category,
                IconUrl = Service.IconUrl,
                EndpointRoute = Service.EndpointRoute,
                IsEnabled = Service.IsEnabled,
                IsFree = Service.IsFree,
                DisplayOrder = Service.DisplayOrder,
                Version = Service.Version,
                Author = Service.Author,
                DocumentationUrl = Service.DocumentationUrl,
                Tags = Service.Tags
            };
        }
        else
        {
            _model.IsEnabled = true;
            _model.IsFree = true;
        }
    }

    private void Cancel() => MudDialog?.Close(DialogResult.Cancel());

    private async Task Save()
    {
        if (_form != null)
        {
            await _form.Validate();
            if (!_formValid) return;
        }

        _saving = true;
        try
        {
            if (Service != null)
            {
                await McpServiceClient.UpdateServiceAsync(Service.Id, _model);
                Snackbar.Add("服务更新成功", Severity.Success);
            }
            else
            {
                await McpServiceClient.CreateServiceAsync(_model);
                Snackbar.Add("服务创建成功", Severity.Success);
            }
            MudDialog?.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"保存失败: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }
}
