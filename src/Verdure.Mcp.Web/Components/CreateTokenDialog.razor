@inject ITokenServiceClient TokenServiceClient
@inject ISnackbar Snackbar
@inject IClipboardService ClipboardService
@inject IStringLocalizer<SharedResources> L

<MudDialog>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_formValid">
            <MudTextField @bind-Value="_tokenName" Label="@L["CreateToken_NameLabel"]" Required="true"
                          RequiredError="@L["CreateToken_NameRequired"]"
                          HelperText="@L["CreateToken_NameHelper"]" />
        </MudForm>

        @if (_createdToken != null)
        {
            <MudAlert Severity="Severity.Warning" Class="mt-4">
                <MudText>
                    @L["CreateToken_SaveWarning"]
                </MudText>
            </MudAlert>

            <MudPaper Class="pa-3 mt-4" Style="background-color: var(--mud-palette-background-grey);">
                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                    <code style="word-break: break-all;">@_createdToken.Token</code>
                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small"
                                   OnClick="@CopyToken" />
                </MudStack>
            </MudPaper>

            <MudText Typo="Typo.body2" Class="mt-2" Color="Color.Secondary">
                @string.Format(L["CreateToken_ExpiresAt"], _createdToken.ExpiresAt?.ToLocalTime().ToString("yyyy-MM-dd HH:mm"))
            </MudText>
        }
    </DialogContent>
    <DialogActions>
        @if (_createdToken == null)
        {
            <MudButton OnClick="Cancel">@L["Cancel"]</MudButton>
            <MudButton Color="Color.Primary" OnClick="Create" Disabled="@(!_formValid || _creating)">
                @if (_creating)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                }
                else
                {
                    <text>@L["Create"]</text>
                }
            </MudButton>
        }
        else
        {
            <MudButton Color="Color.Primary" OnClick="Close">@L["Done"]</MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance? MudDialog { get; set; }

    private MudForm? _form;
    private bool _formValid;
    private bool _creating;
    private string _tokenName = string.Empty;
    private CreateTokenResponse? _createdToken;

    private void Cancel() => MudDialog?.Close(DialogResult.Cancel());
    private void Close() => MudDialog?.Close(DialogResult.Ok(true));

    private async Task Create()
    {
        if (_form != null)
        {
            await _form.Validate();
            if (!_formValid) return;
        }

        _creating = true;
        try
        {
            _createdToken = await TokenServiceClient.CreateTokenAsync(new CreateTokenRequest
            {
                Name = _tokenName
            });
            Snackbar.Add(L["CreateToken_Success"], Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["CreateToken_Failed"], ex.Message), Severity.Error);
        }
        finally
        {
            _creating = false;
        }
    }

    private async Task CopyToken()
    {
        if (_createdToken != null)
        {
            try
            {
                await ClipboardService.CopyToClipboardAsync(_createdToken.Token);
                Snackbar.Add(L["CopiedToClipboard"], Severity.Success);
            }
            catch
            {
                Snackbar.Add(L["CopyFailed"], Severity.Warning);
            }
        }
    }
}
