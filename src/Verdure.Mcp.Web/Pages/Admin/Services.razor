@page "/admin/services"
@attribute [Authorize(Policy = "AdminPolicy")]
@inject IMcpServiceClient McpServiceClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>MCP 服务管理 - Verdure MCP 服务平台</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">MCP 服务管理</MudText>

<MudText Typo="Typo.body1" Class="mb-4" Color="Color.Secondary">
    管理和配置平台上的 MCP 服务
</MudText>

<MudStack Row="true" Justify="Justify.FlexEnd" Class="mb-4">
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@CreateService"
               StartIcon="@Icons.Material.Filled.Add">
        添加服务
    </MudButton>
</MudStack>

<MudTable @ref="_table" 
          ServerData="@(new Func<TableState, CancellationToken, Task<TableData<McpServiceDto>>>(ServerReload))"
          Hover="true" 
          Striped="true" 
          Elevation="2"
          Loading="@_loading"
          LoadingProgressColor="Color.Primary">
    <ToolBarContent>
        <MudText Typo="Typo.h6">服务列表</MudText>
        <MudSpacer />
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mr-4">
            共 @_totalItems 个服务
        </MudText>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>名称</MudTh>
        <MudTh>分类</MudTh>
        <MudTh>端点</MudTh>
        <MudTh>状态</MudTh>
        <MudTh>排序</MudTh>
        <MudTh>操作</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="名称">
            <MudStack Spacing="0">
                <MudText>@context.DisplayName</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Name</MudText>
            </MudStack>
        </MudTd>
        <MudTd DataLabel="分类">
            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">
                @context.Category
            </MudChip>
        </MudTd>
        <MudTd DataLabel="端点">
            <code>@context.EndpointRoute</code>
        </MudTd>
        <MudTd DataLabel="状态">
            @if (context.IsEnabled)
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Success">启用</MudChip>
            }
            else
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Default">禁用</MudChip>
            }
        </MudTd>
        <MudTd DataLabel="排序">@context.DisplayOrder</MudTd>
        <MudTd DataLabel="操作">
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small"
                           OnClick="@(() => EditService(context))" />
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                           OnClick="@(() => DeleteService(context))" />
        </MudTd>
    </RowTemplate>
    <NoRecordsContent>
        <MudPaper Class="pa-8 text-center" Elevation="0">
            <MudIcon Icon="@Icons.Material.Filled.Extension" Size="Size.Large" Color="Color.Secondary" />
            <MudText Typo="Typo.h6" Class="mt-4">暂无服务</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                点击上方按钮添加第一个 MCP 服务
            </MudText>
        </MudPaper>
    </NoRecordsContent>
    <LoadingContent>
        <MudText>加载中...</MudText>
    </LoadingContent>
    <PagerContent>
        <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" 
                       RowsPerPageString="每页显示"
                       InfoFormat="{first_item}-{last_item} / 共 {all_items}"
                       AllItemsText="全部"
                       HorizontalAlignment="HorizontalAlignment.Right" />
    </PagerContent>
</MudTable>

@code {
    private MudTable<McpServiceDto>? _table;
    private bool _loading = true;
    private int _totalItems = 0;

    private async Task<TableData<McpServiceDto>> ServerReload(TableState state, CancellationToken cancellationToken)
    {
        _loading = true;
        StateHasChanged();

        try
        {
            var page = state.Page + 1; // MudTable uses 0-based page index
            var pageSize = state.PageSize;

            var result = await McpServiceClient.GetServicesPagedAdminAsync(page, pageSize);
            
            _totalItems = result.TotalCount;

            return new TableData<McpServiceDto>
            {
                Items = result.Items,
                TotalItems = result.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载服务列表失败: {ex.Message}", Severity.Error);
            return new TableData<McpServiceDto>
            {
                Items = [],
                TotalItems = 0
            };
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task CreateService()
    {
        var parameters = new DialogParameters<ServiceFormDialog>();
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ServiceFormDialog>("添加 MCP 服务", parameters, options);
        var result = await dialog.Result;

        if (!result?.Canceled ?? false)
        {
            if (_table != null)
            {
                await _table.ReloadServerData();
            }
        }
    }

    private async Task EditService(McpServiceDto service)
    {
        var parameters = new DialogParameters<ServiceFormDialog>
        {
            { x => x.Service, service }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ServiceFormDialog>("编辑 MCP 服务", parameters, options);
        var result = await dialog.Result;

        if (!result?.Canceled ?? false)
        {
            if (_table != null)
            {
                await _table.ReloadServerData();
            }
        }
    }

    private async Task DeleteService(McpServiceDto service)
    {
        var result = await DialogService.ShowMessageBox(
            "确认删除",
            $"确定要删除服务 \"{service.DisplayName}\" 吗？此操作不可恢复。",
            yesText: "删除",
            cancelText: "取消");

        if (result == true)
        {
            try
            {
                await McpServiceClient.DeleteServiceAsync(service.Id);
                Snackbar.Add("服务已删除", Severity.Success);
                if (_table != null)
                {
                    await _table.ReloadServerData();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"删除失败: {ex.Message}", Severity.Error);
            }
        }
    }
}
