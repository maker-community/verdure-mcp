@page "/admin/services"
@attribute [Authorize(Policy = "AdminPolicy")]
@inject IMcpServiceClient McpServiceClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IStringLocalizer<SharedResources> L

<PageTitle>@L["AdminServices_PageTitle"]</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">@L["AdminServices_Title"]</MudText>

<MudText Typo="Typo.body1" Class="mb-4" Color="Color.Secondary">
    @L["AdminServices_Subtitle"]
</MudText>

<MudStack Row="true" Justify="Justify.FlexEnd" Class="mb-4">
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@CreateService"
               StartIcon="@Icons.Material.Filled.Add">
        @L["AdminServices_AddService"]
    </MudButton>
</MudStack>

<MudTable @ref="_table" 
          ServerData="@(new Func<TableState, CancellationToken, Task<TableData<McpServiceDto>>>(ServerReload))"
          Hover="true" 
          Striped="true" 
          Elevation="2"
          Loading="@_loading"
          LoadingProgressColor="Color.Primary">
    <ToolBarContent>
        <MudText Typo="Typo.h6">@L["AdminServices_ServiceList"]</MudText>
        <MudSpacer />
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mr-4">
            @string.Format(L["AdminServices_TotalServices"], _totalItems)
        </MudText>
    </ToolBarContent>
    <HeaderContent>
        <MudTh>@L["AdminServices_Name"]</MudTh>
        <MudTh>@L["AdminServices_Category"]</MudTh>
        <MudTh>@L["AdminServices_Endpoint"]</MudTh>
        <MudTh>@L["AdminServices_Status"]</MudTh>
        <MudTh>@L["AdminServices_SortOrder"]</MudTh>
        <MudTh>@L["AdminServices_Actions"]</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="@L["AdminServices_Name"]">
            <MudStack Spacing="0">
                <MudText>@context.DisplayName</MudText>
                <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Name</MudText>
            </MudStack>
        </MudTd>
        <MudTd DataLabel="@L["AdminServices_Category"]">
            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Outlined">
                @context.Category
            </MudChip>
        </MudTd>
        <MudTd DataLabel="@L["AdminServices_Endpoint"]">
            <code>@context.EndpointRoute</code>
        </MudTd>
        <MudTd DataLabel="@L["AdminServices_Status"]">
            @if (context.IsEnabled)
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Success">@L["Enabled"]</MudChip>
            }
            else
            {
                <MudChip T="string" Size="Size.Small" Color="Color.Default">@L["Disabled"]</MudChip>
            }
        </MudTd>
        <MudTd DataLabel="@L["AdminServices_SortOrder"]">@context.DisplayOrder</MudTd>
        <MudTd DataLabel="@L["AdminServices_Actions"]">
            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small"
                           OnClick="@(() => EditService(context))" />
            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                           OnClick="@(() => DeleteService(context))" />
        </MudTd>
    </RowTemplate>
    <NoRecordsContent>
        <MudPaper Class="pa-8 text-center" Elevation="0">
            <MudIcon Icon="@Icons.Material.Filled.Extension" Size="Size.Large" Color="Color.Secondary" />
            <MudText Typo="Typo.h6" Class="mt-4">@L["AdminServices_NoServices"]</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @L["AdminServices_NoServicesHint"]
            </MudText>
        </MudPaper>
    </NoRecordsContent>
    <LoadingContent>
        <MudText>@L["Loading"]</MudText>
    </LoadingContent>
    <PagerContent>
        <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" 
                       RowsPerPageString="@L["AdminServices_RowsPerPage"]"
                       InfoFormat="@L["AdminServices_PagerInfo"]"
                       AllItemsText="@L["All"]"
                       HorizontalAlignment="HorizontalAlignment.Right" />
    </PagerContent>
</MudTable>

@code {
    private MudTable<McpServiceDto>? _table;
    private bool _loading = true;
    private int _totalItems = 0;

    private async Task<TableData<McpServiceDto>> ServerReload(TableState state, CancellationToken cancellationToken)
    {
        _loading = true;
        StateHasChanged();

        try
        {
            var page = state.Page + 1; // MudTable uses 0-based page index
            var pageSize = state.PageSize;

            var result = await McpServiceClient.GetServicesPagedAdminAsync(page, pageSize);
            
            _totalItems = result.TotalCount;

            return new TableData<McpServiceDto>
            {
                Items = result.Items,
                TotalItems = result.TotalCount
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["AdminServices_LoadFailed"], ex.Message), Severity.Error);
            return new TableData<McpServiceDto>
            {
                Items = [],
                TotalItems = 0
            };
        }
        finally
        {
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task CreateService()
    {
        var parameters = new DialogParameters<ServiceFormDialog>();
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ServiceFormDialog>(L["ServiceForm_AddTitle"], parameters, options);
        var result = await dialog.Result;

        if (!result?.Canceled ?? false)
        {
            if (_table != null)
            {
                await _table.ReloadServerData();
            }
        }
    }

    private async Task EditService(McpServiceDto service)
    {
        var parameters = new DialogParameters<ServiceFormDialog>
        {
            { x => x.Service, service }
        };
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ServiceFormDialog>(L["ServiceForm_EditTitle"], parameters, options);
        var result = await dialog.Result;

        if (!result?.Canceled ?? false)
        {
            if (_table != null)
            {
                await _table.ReloadServerData();
            }
        }
    }

    private async Task DeleteService(McpServiceDto service)
    {
        var result = await DialogService.ShowMessageBox(
            L["AdminServices_DeleteConfirmTitle"],
            string.Format(L["AdminServices_DeleteConfirmMessage"], service.DisplayName),
            yesText: L["Delete"],
            cancelText: L["Cancel"]);

        if (result == true)
        {
            try
            {
                await McpServiceClient.DeleteServiceAsync(service.Id);
                Snackbar.Add(L["AdminServices_DeleteSuccess"], Severity.Success);
                if (_table != null)
                {
                    await _table.ReloadServerData();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add(string.Format(L["AdminServices_DeleteFailed"], ex.Message), Severity.Error);
            }
        }
    }
}
