@page "/service/{Id:guid}"
@inject IMcpServiceClient McpServiceClient
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IClipboardService ClipboardService
@inject IStringLocalizer<SharedResources> L

<PageTitle>@string.Format(L["ServiceDetails_PageTitle"], _service?.DisplayName ?? L["ServiceDetails_NotFound"])</PageTitle>

@if (_loading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else if (_service == null)
{
    <MudPaper Class="pa-8 text-center" Style="border-radius: 16px;">
        <MudIcon Icon="@Icons.Material.Filled.Error" Size="Size.Large" Color="Color.Error" />
        <MudText Typo="Typo.h5" Class="mt-4" Style="font-weight: 500;">@L["ServiceDetails_NotFound"]</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" Href="/"
                   Style="border-radius: 20px; text-transform: none;">
            @L["ServiceDetails_BackToHome"]
        </MudButton>
    </MudPaper>
}
else
{
    <MudBreadcrumbs Items="_breadcrumbs" Class="mb-6" />

    <MudGrid Spacing="4">
        <MudItem xs="12" md="8">
            <MudPaper Elevation="0" Class="pa-6" Style="border-radius: 16px; background-color: #FFFFFF; border: 1px solid rgba(124, 77, 255, 0.12); box-shadow: 0 2px 8px rgba(124, 77, 255, 0.06);">
                <MudStack Row="true" AlignItems="AlignItems.Start" Class="mb-5" Spacing="3">
                    <MudAvatar Color="Color.Primary" Size="Size.Large" Style="border-radius: 16px;">
                        @GetCategoryIcon(_service.Category)
                    </MudAvatar>
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.h4" Style="font-weight: 500; line-height: 1.3;">@_service.DisplayName</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Style="margin-top: 4px;">@_service.Name</MudText>
                    </MudStack>
                </MudStack>

                <MudStack Row="true" Spacing="2" Class="mb-5" Wrap="Wrap.Wrap">
                    @if (_service.IsFree)
                    {
                        <MudChip T="string" Color="Color.Success" Size="Size.Small" 
                                 Style="border-radius: 12px; font-weight: 500;">免费</MudChip>
                    }
                    <MudChip T="string" Color="Color.Primary" Size="Size.Small" Variant="Variant.Outlined"
                             Style="border-radius: 12px;">
                        @_service.Category
                    </MudChip>
                    @if (!string.IsNullOrEmpty(_service.Version))
                    {
                        <MudChip T="string" Color="Color.Default" Size="Size.Small" Variant="Variant.Outlined"
                                 Style="border-radius: 12px;">
                            v@_service.Version
                        </MudChip>
                    }
                </MudStack>

                <MudDivider Class="mb-5" />

                <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 500;">@L["ServiceDetails_Description"]</MudText>
                <MudText Typo="Typo.body1" Class="mb-5" Style="line-height: 1.75; color: rgba(0, 0, 0, 0.75);">
                    @(_service.Description ?? L["NoDescription"])
                </MudText>

                <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 500;">@L["ServiceDetails_Endpoint"]</MudText>
                <MudPaper Class="pa-4 mb-5" Elevation="0" Style="background-color: var(--mud-palette-surface-container-low); border-radius: 12px;">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                        <code style="font-family: 'Fira Code', 'Consolas', monospace; font-size: 0.9rem;">@_service.EndpointRoute</code>
                        <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Size="Size.Small"
                                       OnClick="@(() => CopyToClipboard(_service.EndpointRoute))"
                                       Style="border-radius: 8px;" />
                    </MudStack>
                </MudPaper>

                @if (!string.IsNullOrEmpty(_service.Tags))
                {
                    <MudText Typo="Typo.h6" Class="mb-3" Style="font-weight: 500;">@L["ServiceDetails_Tags"]</MudText>
                    <MudStack Row="true" Spacing="2" Class="mb-5" Wrap="Wrap.Wrap">
                        @foreach (var tag in _service.Tags.Split(','))
                        {
                            <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" 
                                     Style="border-radius: 12px;">@tag.Trim()</MudChip>
                        }
                    </MudStack>
                }

                @if (!string.IsNullOrEmpty(_service.Author))
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary" Style="line-height: 1.6;">
                        @string.Format(L["ServiceDetails_Author"], _service.Author)
                    </MudText>
                }
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <MudPaper Elevation="0" Class="pa-5 mb-4" Style="border-radius: 16px; background-color: #FFFFFF; border: 1px solid rgba(124, 77, 255, 0.12); box-shadow: 0 2px 8px rgba(124, 77, 255, 0.06);">
                <MudText Typo="Typo.h6" Class="mb-4" Style="font-weight: 500;">@L["ServiceDetails_QuickActions"]</MudText>
                
                @if (!string.IsNullOrEmpty(_service.DocumentationUrl))
                {
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" Class="mb-3"
                               Href="@_service.DocumentationUrl" Target="_blank"
                               StartIcon="@Icons.Material.Filled.Description"
                               Style="border-radius: 20px; text-transform: none; height: 44px;">
                        @L["ServiceDetails_ViewDocs"]
                    </MudButton>
                }
                
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth="true"
                           Href="https://xiaozhi.verdure-hiro.cn/" Target="_blank"
                           StartIcon="@Icons.Material.Filled.Link"
                           Style="border-radius: 20px; text-transform: none; height: 44px;">
                    @L["ServiceDetails_ConfigureOnXiaozhi"]
                </MudButton>
            </MudPaper>

            <MudPaper Elevation="0" Class="pa-5" Style="background: linear-gradient(135deg, #FCE4EC 0%, #F8BBD0 100%); border-radius: 16px; border: 2px solid #E91E63;">
                <MudIcon Icon="@Icons.Material.Filled.Favorite" Color="Color.Tertiary" Size="Size.Large" Class="mb-3" />
                <MudText Typo="Typo.h6" Color="Color.Default" Class="mb-2" Style="font-weight: 500;">
                    @L["ServiceDetails_SupportUs"]
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Default" Class="mb-4" Style="line-height: 1.6;">
                    @L["ServiceDetails_SupportDesc"]
                </MudText>
                <MudButton Variant="Variant.Filled" Color="Color.Tertiary" FullWidth="true"
                           Href="/support"
                           StartIcon="@Icons.Material.Filled.Favorite"
                           Style="border-radius: 20px; text-transform: none; height: 44px;">
                    @L["ServiceDetails_GoSupport"]
                </MudButton>
            </MudPaper>
        </MudItem>
    </MudGrid>
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private bool _loading = true;
    private McpServiceDto? _service;
    private List<BreadcrumbItem> _breadcrumbs = [];

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _service = await McpServiceClient.GetServiceAsync(Id);
            
            _breadcrumbs =
            [
                new BreadcrumbItem("首页", "/"),
                new BreadcrumbItem("MCP 广场", "/"),
                new BreadcrumbItem(_service?.DisplayName ?? "服务详情", null, disabled: true)
            ];
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载服务详情失败: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private string GetCategoryIcon(string category) => category.ToLower() switch
    {
        "image" => Icons.Material.Filled.Image,
        "email" => Icons.Material.Filled.Email,
        "document" => Icons.Material.Filled.Description,
        "data" => Icons.Material.Filled.DataObject,
        "ai" => Icons.Material.Filled.Psychology,
        _ => Icons.Material.Filled.Extension
    };

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await ClipboardService.CopyToClipboardAsync(text);
            Snackbar.Add("已复制到剪贴板", Severity.Success);
        }
        catch
        {
            Snackbar.Add("复制失败，请手动复制", Severity.Warning);
        }
    }
}
