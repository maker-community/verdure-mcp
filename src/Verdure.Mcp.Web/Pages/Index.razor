@page "/"
@inject IMcpServiceClient McpServiceClient
@inject ISnackbar Snackbar

<PageTitle>MCP 广场 - Verdure MCP 服务平台</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">MCP 服务广场</MudText>

<MudText Typo="Typo.body1" Class="mb-4" Color="Color.Secondary">
    探索和使用各种 MCP 服务，让 AI 助手更加强大
</MudText>

<MudPaper Elevation="0" Class="pa-4 mb-4" Style="background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-tertiary) 100%); color: white;">
    <MudGrid>
        <MudItem xs="12" md="8">
            <MudText Typo="Typo.h5" Style="color: white;">无缝连接小智 MCP 转接平台</MudText>
            <MudText Typo="Typo.body1" Style="color: white;" Class="mt-2">
                使用我们的 MCP 服务，配合小智 MCP 转接平台，轻松为您的小智 AI 助手添加更多能力
            </MudText>
            <MudButton Variant="Variant.Filled" Style="color: white;" Class="mt-3"
                       Href="https://xiaozhi.verdure-hiro.cn/" Target="_blank"
                       EndIcon="@Icons.Material.Filled.OpenInNew">
                前往小智 MCP 转接平台
            </MudButton>
        </MudItem>
    </MudGrid>
</MudPaper>

@if (_loading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
}
else
{
    <MudGrid Class="mb-4">
        <MudItem xs="12">
            <MudChipSet T="string" @bind-SelectedValue="_selectedCategory" SelectionMode="SelectionMode.SingleSelection">
                <MudChip T="string" Value="@string.Empty" Color="Color.Primary" Variant="@(string.IsNullOrEmpty(_selectedCategory) ? Variant.Filled : Variant.Outlined)">
                    全部
                </MudChip>
                @foreach (var category in _categories)
                {
                    <MudChip T="string" Value="@category.Name" Color="Color.Primary" 
                             Variant="@(_selectedCategory == category.Name ? Variant.Filled : Variant.Outlined)">
                        @category.DisplayName (@category.ServiceCount)
                    </MudChip>
                }
            </MudChipSet>
        </MudItem>
    </MudGrid>

    <MudGrid>
        @foreach (var service in FilteredServices)
        {
            <MudItem xs="12" sm="6" md="4">
                <MudCard Elevation="2" Class="h-100">
                    <MudCardHeader>
                        <CardHeaderAvatar>
                            <MudAvatar Color="Color.Primary">
                                @GetCategoryIcon(service.Category)
                            </MudAvatar>
                        </CardHeaderAvatar>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@service.DisplayName</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@service.Category</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            @if (service.IsFree)
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Success">免费</MudChip>
                            }
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudText Typo="Typo.body2">@(service.Description ?? "暂无描述")</MudText>
                        @if (!string.IsNullOrEmpty(service.Tags))
                        {
                            <MudStack Row="true" Spacing="1" Class="mt-2">
                                @foreach (var tag in service.Tags.Split(',').Take(3))
                                {
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined">@tag.Trim()</MudChip>
                                }
                            </MudStack>
                        }
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" 
                                   Href="@($"/service/{service.Id}")">
                            查看详情
                        </MudButton>
                        @if (!string.IsNullOrEmpty(service.DocumentationUrl))
                        {
                            <MudButton Variant="Variant.Text" Color="Color.Secondary"
                                       Href="@service.DocumentationUrl" Target="_blank">
                                文档
                            </MudButton>
                        }
                    </MudCardActions>
                </MudCard>
            </MudItem>
        }
    </MudGrid>

    @if (!FilteredServices.Any())
    {
        <MudPaper Class="pa-8 text-center" Elevation="0">
            <MudIcon Icon="@Icons.Material.Filled.SearchOff" Size="Size.Large" Color="Color.Secondary" />
            <MudText Typo="Typo.h6" Class="mt-4">暂无服务</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">
                @if (string.IsNullOrEmpty(_selectedCategory))
                {
                    <text>目前没有可用的 MCP 服务</text>
                }
                else
                {
                    <text>该分类下暂无服务</text>
                }
            </MudText>
        </MudPaper>
    }
}

@code {
    private bool _loading = true;
    private List<McpServiceDto> _services = [];
    private List<McpCategoryDto> _categories = [];
    private string? _selectedCategory;

    private IEnumerable<McpServiceDto> FilteredServices => 
        string.IsNullOrEmpty(_selectedCategory) 
            ? _services 
            : _services.Where(s => s.Category.Equals(_selectedCategory, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _services = await McpServiceClient.GetServicesAsync();
            _categories = await McpServiceClient.GetCategoriesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"加载服务列表失败: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private string GetCategoryIcon(string category) => category.ToLower() switch
    {
        "image" => Icons.Material.Filled.Image,
        "email" => Icons.Material.Filled.Email,
        "document" => Icons.Material.Filled.Description,
        "data" => Icons.Material.Filled.DataObject,
        "ai" => Icons.Material.Filled.Psychology,
        _ => Icons.Material.Filled.Extension
    };
}
