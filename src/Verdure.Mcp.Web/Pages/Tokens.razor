@page "/tokens"
@attribute [Authorize]
@inject ITokenServiceClient TokenServiceClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IStringLocalizer<SharedResources> L

<PageTitle>@L["Tokens_PageTitle"]</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">@L["Tokens_Title"]</MudText>

<MudText Typo="Typo.body1" Class="mb-4" Color="Color.Secondary">
    @L["Tokens_Subtitle"]
</MudText>

<MudAlert Severity="Severity.Info" Class="mb-4">
    <MudText>
        <strong>@L["Tokens_Notice"]</strong>
    </MudText>
</MudAlert>

<MudStack Row="true" Justify="Justify.FlexEnd" Class="mb-4">
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@CreateToken"
               StartIcon="@Icons.Material.Filled.Add">
        @L["Tokens_CreateNew"]
    </MudButton>
</MudStack>

@if (_loading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-4" />
}
else if (!_tokens.Any())
{
    <MudPaper Class="pa-8 text-center" Elevation="0">
        <MudIcon Icon="@Icons.Material.Filled.Key" Size="Size.Large" Color="Color.Secondary" />
        <MudText Typo="Typo.h6" Class="mt-4">@L["Tokens_NoKeys"]</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            @L["Tokens_NoKeysHint"]
        </MudText>
    </MudPaper>
}
else
{
    <MudTable Items="@_tokens" Hover="true" Striped="true" Elevation="2">
        <HeaderContent>
            <MudTh>@L["Tokens_Name"]</MudTh>
            <MudTh>@L["Tokens_Status"]</MudTh>
            <MudTh>@L["Tokens_CreatedAt"]</MudTh>
            <MudTh>@L["Tokens_ExpiresAt"]</MudTh>
            <MudTh>@L["Tokens_TodayUsage"]</MudTh>
            <MudTh>@L["Tokens_LastUsed"]</MudTh>
            <MudTh>@L["Tokens_Actions"]</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="@L["Tokens_Name"]">@context.Name</MudTd>
            <MudTd DataLabel="@L["Tokens_Status"]">
                @if (context.IsActive)
                {
                    @if (context.ExpiresAt.HasValue && context.ExpiresAt.Value < DateTime.UtcNow)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Error">@L["Tokens_Expired"]</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success">@L["Tokens_Valid"]</MudChip>
                    }
                }
                else
                {
                    <MudChip T="string" Size="Size.Small" Color="Color.Default">@L["Tokens_Revoked"]</MudChip>
                }
            </MudTd>
            <MudTd DataLabel="@L["Tokens_CreatedAt"]">@context.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd HH:mm")</MudTd>
            <MudTd DataLabel="@L["Tokens_ExpiresAt"]">
                @if (context.ExpiresAt.HasValue)
                {
                    @context.ExpiresAt.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                }
                else
                {
                    <text>@L["NeverExpires"]</text>
                }
            </MudTd>
            <MudTd DataLabel="@L["Tokens_TodayUsage"]">@context.TodayImageCount / @context.DailyImageLimit</MudTd>
            <MudTd DataLabel="@L["Tokens_LastUsed"]">
                @if (context.LastUsedAt.HasValue)
                {
                    @context.LastUsedAt.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
                }
                else
                {
                    <text>@L["NeverUsed"]</text>
                }
            </MudTd>
            <MudTd DataLabel="@L["Tokens_Actions"]">
                @if (context.IsActive)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                   OnClick="@(() => RevokeToken(context))" />
                }
            </MudTd>
        </RowTemplate>
    </MudTable>
}

@code {
    private bool _loading = true;
    private List<ApiTokenDto> _tokens = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadTokens();
    }

    private async Task LoadTokens()
    {
        _loading = true;
        try
        {
            _tokens = await TokenServiceClient.GetUserTokensAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add(string.Format(L["Tokens_LoadFailed"], ex.Message), Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task CreateToken()
    {
        var parameters = new DialogParameters<CreateTokenDialog>();
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small };
        var dialog = await DialogService.ShowAsync<CreateTokenDialog>(L["CreateToken_DialogTitle"], parameters, options);
        var result = await dialog.Result;

        if (!result?.Canceled ?? false)
        {
            await LoadTokens();
        }
    }

    private async Task RevokeToken(ApiTokenDto token)
    {
        var result = await DialogService.ShowMessageBox(
            L["Tokens_RevokeConfirmTitle"],
            string.Format(L["Tokens_RevokeConfirmMessage"], token.Name),
            yesText: L["Revoke"],
            cancelText: L["Cancel"]);

        if (result == true)
        {
            try
            {
                await TokenServiceClient.RevokeTokenAsync(token.Id);
                Snackbar.Add(L["Tokens_RevokeSuccess"], Severity.Success);
                await LoadTokens();
            }
            catch (Exception ex)
            {
                Snackbar.Add(string.Format(L["Tokens_RevokeFailed"], ex.Message), Severity.Error);
            }
        }
    }
}
