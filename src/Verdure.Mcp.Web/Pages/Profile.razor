@page "/profile"
@attribute [Authorize]
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IStringLocalizer<SharedResources> L

<PageTitle>@L["Profile_PageTitle"]</PageTitle>

<MudText Typo="Typo.h4" Class="mb-4">@L["Profile_Title"]</MudText>

<AuthorizeView>
    <Authorized>
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudPaper Elevation="2" Class="pa-6">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                        <MudAvatar Color="Color.Primary" Size="Size.Large">
                            @GetInitials(context.User.Identity?.Name)
                        </MudAvatar>
                        <MudStack Spacing="0">
                            <MudText Typo="Typo.h5">@context.User.Identity?.Name</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @GetUserEmail(context.User)
                            </MudText>
                        </MudStack>
                    </MudStack>

                    <MudDivider Class="mb-4" />

                    <MudList T="string">
                        <MudListItem Icon="@Icons.Material.Filled.Badge">
                            <MudText>@string.Format(L["Profile_UserId"], GetUserId(context.User))</MudText>
                        </MudListItem>
                        <MudListItem Icon="@Icons.Material.Filled.Security">
                            <MudText>@string.Format(L["Profile_Role"], GetRoles(context.User))</MudText>
                        </MudListItem>
                    </MudList>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudPaper Elevation="2" Class="pa-6">
                    <MudText Typo="Typo.h6" Class="mb-4">@L["Profile_QuickActions"]</MudText>
                    
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" Class="mb-2"
                               Href="/tokens"
                               StartIcon="@Icons.Material.Filled.Key">
                        @L["Profile_ManageApiKeys"]
                    </MudButton>
                    
                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth="true" Class="mb-2"
                               Href="/"
                               StartIcon="@Icons.Material.Filled.Home">
                        @L["Profile_BrowseMcpServices"]
                    </MudButton>
                    
                    <MudButton Variant="Variant.Outlined" Color="Color.Tertiary" FullWidth="true"
                               Href="/support"
                               StartIcon="@Icons.Material.Filled.Favorite">
                        @L["Nav_SupportUs"]
                    </MudButton>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </Authorized>
</AuthorizeView>

@code {
    private string GetInitials(string? name)
    {
        if (string.IsNullOrEmpty(name)) return "U";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        return name[..Math.Min(2, name.Length)].ToUpper();
    }

    private string GetUserEmail(System.Security.Claims.ClaimsPrincipal user)
    {
        var email = user.GetEmail();
        return string.IsNullOrEmpty(email) ? L["Profile_NoEmail"] : email;
    }

    private string GetUserId(System.Security.Claims.ClaimsPrincipal user)
    {
        try
        {
            return user.GetUserId();
        }
        catch
        {
            return L["Profile_Unknown"];
        }
    }

    private string GetRoles(System.Security.Claims.ClaimsPrincipal user)
    {
        var roles = user.GetRoles();
        return roles.Any() ? string.Join(", ", roles) : L["Profile_NormalUser"];
    }
}
